<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../dig-common/dig-common.html">

<!--
An element which builds an elasticjs query based on the set attributes.

Example:

        <elastic-client-query-builder
            type: "terms"
            fields: '"myField"'
            values: '["value1","value2"]'
            ejs-query: "{{ejsQuery}}">
        </elastic-client-query-builder>

@demo demo/index.html
-->

<dom-module id="elastic-client-query-builder">
    <template>
    </template>

    <script>
        (function() {
            Polymer({
                is: 'elastic-client-query-builder',

                properties: {
                    /**
                     * The string field or array of fields for the query.
                    */
                    fields: {
                        type: Array
                    },

                    /**
                     * The string value or array of values for the query.  For more-like-this queries, the value for the 'like' property.
                     */
                    values: {
                        type: Array
                    },

                    /**
                     * The type of query to build.
                     * Supported types:
                     * 'match_all', 'match', 'term', 'terms', 'mlt' (more-like-this)
                     */
                    type: {
                        type: String
                    },

                    /**
                     * Whether to build a filtered query.  If true, the query will be built using 'ejsFilter' and an elasticjs query built using 'type', 'fields', and 'values'.
                     */
                    filtered: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * The elasticjs filter for a filtered query.  Only used if the filtered property is true.
                     */
                    ejsFilter: {
                        type: Object,
                        value: function() {
                            return null;
                        }
                    },

                    /**
                     * The array of elasticjs query objects to use with this elasticsearch bool query.  Only used if type is set to bool.
                     */
                    ejsBoolQueries: {
                        type: Array,
                        value: function() {
                            return [];
                        }
                    },

                    /**
                     * The object with properties for configuration options of mlt (more-like-this) queries.
                     * Supported properties:
                     * 'minTermFreq', 'maxQueryTerms', 'stopWords', 'minDocFreq', 'maxDocFreq', 'analyzer'
                     */
                    mltConfig: {
                        type: Object,
                        value: function() {
                            return {};
                        }
                    },

                    /**
                     * The built elasticjs query.
                     */
                    ejsQuery: {
                        type: Object,
                        readOnly: true,
                        notify: true
                    }
                },

                observers : [
                    'buildUnfilteredQuery(type, fields, values, filtered)',
                    'buildFilteredQuery(type, fields, values, filtered, ejsFilter)',
                    'buildBoolQuery(type, ejsBoolQueries)'
                ],

                buildQuery: function(type, fields, values) {
                    var ejsQuery;
                    if(type === 'match_all') {
                        ejsQuery = ejs.MatchAllQuery();
                    }
                    else if(!values || (values.constructor === Array && !values.length)) {
                        this._setEjsQuery(null);
                    }
                    else if(fields) {
                        var queryField = (fields.constructor === Array && fields.length === 1) ? fields[0] : fields;
                        var queryValue = (values.constructor === Array && values.length === 1) ? values[0] : values;
                        if(type === 'match') {
                            ejsQuery = ejs.MatchQuery(queryField, queryValue);
                        }
                        if(type === 'term') {
                            ejsQuery = ejs.TermQuery(queryField, queryValue);
                        }
                        if(type === 'terms') {
                            ejsQuery = ejs.TermsQuery(queryField, queryValue);
                        }
                        if(type === 'mlt') {
                            ejsQuery = this.buildMoreLikeThisQuery(ejs.MoreLikeThisQuery(fields, values), this.mltConfig);
                        }
                    }
                    return ejsQuery;
                },

                buildMoreLikeThisQuery: function(ejsQuery, mltConfig) {
                    var mltQuery = ejsQuery;
                    if(mltConfig) {
                        if(mltConfig.minTermFreq) {
                            mltQuery = mltQuery.minTermFreq(mltConfig.minTermFreq);
                        }
                        if(mltConfig.maxQueryTerms) {
                            mltQuery = mltQuery.maxQueryTerms(mltConfig.maxQueryTerms);
                        }
                        if(mltConfig.stopWords) {
                            mltQuery = mltQuery.stopWords(mltConfig.stopWords);
                        }
                        if(mltConfig.minDocFreq) {
                            mltQuery = mltQuery.minDocFreq(mltConfig.minDocFreq);
                        }
                        if(mltConfig.maxDocFreq) {
                            mltQuery = mltQuery.maxDocFreq(mltConfig.maxDocFreq);
                        }
                        if(mltConfig.analyzer) {
                            mltQuery = mltQuery.analyzer(mltConfig.analyzer);
                        }
                    }
                    return mltQuery;
                },

                buildUnfilteredQuery: function(type, fields, values, filtered) {
                    if(filtered) {
                        return;
                    }
                    var ejsQuery = this.buildQuery(type, fields, values);
                    if(ejsQuery) {
                        this._setEjsQuery(ejsQuery);
                    }
                },

                buildFilteredQuery: function(type, fields, values, filtered, ejsFilter) {
                    if(!filtered || !ejsFilter) {
                        return;
                    }
                    var ejsQuery = this.buildQuery(type, fields, values);
                    if(ejsQuery) {
                        this._setEjsQuery(ejs.FilteredQuery(ejsQuery, ejsFilter));
                    }
                },

                buildBoolQuery: function(type, ejsBoolQueries) {
                    if(type === 'bool' && ejsBoolQueries.length) {
                        var ejsQuery = ejs.BoolQuery();
                        ejsBoolQueries.forEach(function(query) {
                            ejsQuery.must(query);
                        });
                        this._setEjsQuery(ejsQuery);
                    }
                }
            });
        })();
    </script>
</dom-module>

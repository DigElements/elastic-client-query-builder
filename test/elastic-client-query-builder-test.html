<!doctype html>

<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

        <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
        <script src="../../web-component-tester/browser.js"></script>

        <link rel="import" href="../elastic-client-query-builder.html">
    </head>
    <body>
        <test-fixture id="elastic-client-query-builder-fixture">
            <template>
                <elastic-client-query-builder>
                </elastic-client-query-builder>
            </template>
        </test-fixture>

        <script>
            suite('<elastic-client-query-builder> for match all', function() {
                var component;

                setup(function(done) {
                    component = fixture('elastic-client-query-builder-fixture');
                    component.type = 'match_all';
                    component.fields = '';
                    component.values = '';
                    flush(function() {
                        done();
                    });
                });

                test('filtered is set correctly', function() {
                    expect(component.filtered).to.exist;
                    expect(component.filtered).to.be.false;
                });

                test('type is set correctly', function() {
                    expect(component.type).to.exist;
                    expect(component.type).to.equal('match_all');
                });

                test('fields is set correctly', function() {
                    expect(component.fields).to.exist;
                    expect(component.fields).to.equal('');
                });

                test('values is set correctly', function() {
                    expect(component.values).to.exist;
                    expect(component.values).to.equal('');
                });

                test('term query is built correctly', function() {
                    expect(component.ejsQuery).to.exist;
                    expect(component.ejsQuery.toJSON()).to.deep.equal(ejs.MatchAllQuery().toJSON());
                });
            });

            suite('<elastic-client-query-builder> for match', function() {
                var component;

                setup(function(done) {
                    component = fixture('elastic-client-query-builder-fixture');
                    component.type = 'match';
                    component.fields = 'testField';
                    component.values = 'testValue';
                    flush(function() {
                        done();
                    });
                });

                test('filtered is set correctly', function() {
                    expect(component.filtered).to.exist;
                    expect(component.filtered).to.be.false;
                });

                test('type is set correctly', function() {
                    expect(component.type).to.exist;
                    expect(component.type).to.equal('match');
                });

                test('fields is set correctly', function() {
                    expect(component.fields).to.exist;
                    expect(component.fields).to.equal('testField');
                });

                test('values is set correctly', function() {
                    expect(component.values).to.exist;
                    expect(component.values).to.equal('testValue');
                });

                test('match query is built correctly', function() {
                    expect(component.ejsQuery).to.exist;
                    expect(component.ejsQuery.toJSON()).to.deep.equal(ejs.MatchQuery('testField', 'testValue').toJSON());
                });
            });

            suite('<elastic-client-query-builder> for filtered match', function() {
                var component;

                setup(function(done) {
                    component = fixture('elastic-client-query-builder-fixture');
                    component.filtered = true;
                    component.type = 'match';
                    component.fields = 'testField';
                    component.values = 'testValue';
                    flush(function() {
                        done();
                    });
                });

                test('filtered is set correctly', function() {
                    expect(component.filtered).to.exist;
                    expect(component.filtered).to.be.true;
                });

                test('type is set correctly', function() {
                    expect(component.type).to.exist;
                    expect(component.type).to.equal('match');
                });

                test('fields is set correctly', function() {
                    expect(component.fields).to.exist;
                    expect(component.fields).to.equal('testField');
                });

                test('values is set correctly', function() {
                    expect(component.values).to.exist;
                    expect(component.values).to.equal('testValue');
                });

                test('filter is set correctly', function() {
                    expect(component.ejsFilter).to.be.null;
                });

                test('query is not built if filter is not set', function() {
                    expect(component.ejsQuery).to.not.exist;
                });

                test('query is built once filter is set', function() {
                    var ejsFilter = ejs.TermFilter('filterField', 'filterValue');
                    component.ejsFilter = ejsFilter;
                    expect(component.ejsFilter).to.exist;
                    expect(component.ejsFilter.toJSON()).to.deep.equal(ejsFilter.toJSON());
                    expect(component.ejsQuery).to.exist;
                    expect(component.ejsQuery.toJSON()).to.deep.equal(ejs.FilteredQuery(ejs.MatchQuery('testField', 'testValue'), ejsFilter).toJSON());
                });
            });

            suite('<elastic-client-query-builder> for term', function() {
                var component;

                setup(function(done) {
                    component = fixture('elastic-client-query-builder-fixture');
                    component.type = 'term';
                    component.fields = 'testField';
                    component.values = 'testValue';
                    flush(function() {
                        done();
                    });
                });

                test('filtered is set correctly', function() {
                    expect(component.filtered).to.exist;
                    expect(component.filtered).to.be.false;
                });

                test('type is set correctly', function() {
                    expect(component.type).to.exist;
                    expect(component.type).to.equal('term');
                });

                test('fields is set correctly', function() {
                    expect(component.fields).to.exist;
                    expect(component.fields).to.equal('testField');
                });

                test('values is set correctly', function() {
                    expect(component.values).to.exist;
                    expect(component.values).to.equal('testValue');
                });

                test('term query is built correctly', function() {
                    expect(component.ejsQuery).to.exist;
                    expect(component.ejsQuery.toJSON()).to.deep.equal(ejs.TermQuery('testField', 'testValue').toJSON());
                });
            });

            suite('<elastic-client-query-builder> for terms', function() {
                var component;

                setup(function(done) {
                    component = fixture('elastic-client-query-builder-fixture');
                    component.type = 'terms';
                    component.fields = 'testField';
                    component.values = 'testValue';
                    flush(function() {
                        done();
                    });
                });

                test('filtered is set correctly', function() {
                    expect(component.filtered).to.exist;
                    expect(component.filtered).to.be.false;
                });

                test('type is set correctly', function() {
                    expect(component.type).to.exist;
                    expect(component.type).to.equal('terms');
                });

                test('fields is set correctly', function() {
                    expect(component.fields).to.exist;
                    expect(component.fields).to.equal('testField');
                });

                test('values is set correctly', function() {
                    expect(component.values).to.exist;
                    expect(component.values).to.equal('testValue');
                });

                test('term query is built correctly', function() {
                    expect(component.ejsQuery).to.exist;
                    expect(component.ejsQuery.toJSON()).to.deep.equal(ejs.TermsQuery('testField', 'testValue').toJSON());
                });
            });

            suite('<elastic-client-query-builder> for terms array', function() {
                var component;

                setup(function(done) {
                    component = fixture('elastic-client-query-builder-fixture');
                    component.type = 'terms';
                    component.fields = 'testField';
                    component.values = ['testValue1', 'testValue2'];
                    flush(function() {
                        done();
                    });
                });

                test('type is set correctly', function() {
                    expect(component.type).to.exist;
                    expect(component.type).to.equal('terms');
                });

                test('fields is set correctly', function() {
                    expect(component.fields).to.exist;
                    expect(component.fields).to.equal('testField');
                });

                test('values is set correctly', function() {
                    expect(component.values).to.exist;
                    expect(component.values).to.be.an('Array');
                    expect(component.values).to.deep.equal(['testValue1', 'testValue2']);
                });

                test('terms query is built correctly', function() {
                    expect(component.ejsQuery).to.exist;
                    expect(component.ejsQuery.toJSON()).to.deep.equal(ejs.TermsQuery('testField', ['testValue1', 'testValue2']).toJSON());
                });
            });

            suite('<elastic-client-query-builder> for terms with one value', function() {
                var component;

                setup(function(done) {
                    component = fixture('elastic-client-query-builder-fixture');
                    component.type = 'terms';
                    component.fields = 'testField';
                    component.values = ['testValue'];
                    flush(function() {
                        done();
                    });
                });

                test('type is set correctly', function() {
                    expect(component.type).to.exist;
                    expect(component.type).to.equal('terms');
                });

                test('fields is set correctly', function() {
                    expect(component.fields).to.exist;
                    expect(component.fields).to.equal('testField');
                });

                test('values is set correctly', function() {
                    expect(component.values).to.exist;
                    expect(component.values).to.be.an('Array');
                    expect(component.values).to.deep.equal(['testValue']);
                });

                test('terms query is built correctly', function() {
                    expect(component.ejsQuery).to.exist;
                    expect(component.ejsQuery.toJSON()).to.deep.equal(ejs.TermsQuery('testField', 'testValue').toJSON());
                });
            });

            suite('<elastic-client-query-builder> for bool', function() {
                var component;

                setup(function(done) {
                    component = fixture('elastic-client-query-builder-fixture');
                    component.type = 'bool';
                    flush(function() {
                        done();
                    });
                });

                test('type is set correctly', function() {
                    expect(component.type).to.exist;
                    expect(component.type).to.equal('bool');
                });

                test('query is not built if bool queries are not set', function() {
                    expect(component.ejsQuery).to.not.exist;
                });

                test('query is built once bool queries are set', function() {
                    var query1 = ejs.TermQuery('field1', 'value1');
                    var query2 = ejs.TermQuery('field2', 'value2');
                    component.ejsBoolQueries = [query1, query2];
                    expect(component.ejsBoolQueries).to.exist;
                    expect(component.ejsBoolQueries).to.be.an('Array');
                    expect(component.ejsBoolQueries.length).to.equal(2);
                    expect(component.ejsBoolQueries[0].toJSON()).to.deep.equal(query1.toJSON());
                    expect(component.ejsBoolQueries[1].toJSON()).to.deep.equal(query2.toJSON());
                    expect(component.ejsQuery).to.exist;
                    expect(component.ejsQuery.toJSON()).to.deep.equal(ejs.BoolQuery().must(query1).must(query2).toJSON());
                });
            });

            suite('<elastic-client-query-builder> for no values', function() {
                var component;

                setup(function(done) {
                    component = fixture('elastic-client-query-builder-fixture');
                    component.type = 'term';
                    component.fields = 'testField';
                    component.values = '';
                    flush(function() {
                        done();
                    });
                });

                test('type is set correctly', function() {
                    expect(component.type).to.exist;
                    expect(component.type).to.equal('term');
                });

                test('fields is set correctly', function() {
                    expect(component.fields).to.exist;
                    expect(component.fields).to.equal('testField');
                });

                test('values is set correctly', function() {
                    expect(component.values).to.exist;
                    expect(component.values).to.equal('');
                });

                test('query is not built', function() {
                    expect(component.ejsQuery).to.be.null;
                });
            });

            suite('<elastic-client-query-builder> for more-like-this query', function() {
                var component;

                setup(function(done) {
                    component = fixture('elastic-client-query-builder-fixture');
                    component.type = 'mlt';
                    component.fields = ['testField'];
                    component.values = 'testValue';
                    flush(function() {
                        done();
                    });
                });

                test('type is set correctly', function() {
                    expect(component.type).to.exist;
                    expect(component.type).to.equal('mlt');
                });

                test('fields is set correctly', function() {
                    expect(component.fields).to.exist;
                    expect(component.fields).to.deep.equal(['testField']);
                });

                test('values is set correctly', function() {
                    expect(component.values).to.exist;
                    expect(component.values).to.equal('testValue');
                });

                test('mltConfig is empty', function() {
                    expect(component.mltConfig).to.deep.equal({});
                });

                test('more-like-this query is built correctly', function() {
                    expect(component.ejsQuery).to.exist;
                    expect(component.ejsQuery.toJSON()).to.deep.equal(ejs.MoreLikeThisQuery(['testField'], 'testValue').toJSON());
                });
            });

            suite('<elastic-client-query-builder> for more-like-this query with config', function() {
                var component;

                setup(function(done) {
                    component = fixture('elastic-client-query-builder-fixture');
                    component.type = 'mlt';
                    component.mltConfig = {
                        minTermFreq: 2,
                        maxQueryTerms: 50,
                        stopWords: 'testStopWord',
                        minDocFreq: 1,
                        maxDocFreq: 100,
                        analyzer: 'testAnalyzer'
                    };
                    component.fields = ['testField'];
                    component.values = 'testValue';
                    flush(function() {
                        done();
                    });
                });

                test('type is set correctly', function() {
                    expect(component.type).to.exist;
                    expect(component.type).to.equal('mlt');
                });

                test('fields is set correctly', function() {
                    expect(component.fields).to.exist;
                    expect(component.fields).to.deep.equal(['testField']);
                });

                test('values is set correctly', function() {
                    expect(component.values).to.exist;
                    expect(component.values).to.deep.equal('testValue');
                });

                test('mltConfig is set correctly', function() {
                    expect(component.mltConfig).to.exist;
                    expect(component.mltConfig).to.deep.equal({
                        minTermFreq: 2,
                        maxQueryTerms: 50,
                        stopWords: 'testStopWord',
                        minDocFreq: 1,
                        maxDocFreq: 100,
                        analyzer: 'testAnalyzer'
                    });
                });

                test('more-like-this query is built correctly with config', function() {
                    expect(component.ejsQuery).to.exist;
                    var expected = ejs.MoreLikeThisQuery(['testField'], 'testValue')
                        .minTermFreq(2)
                        .maxQueryTerms(50)
                        .stopWords('testStopWord')
                        .minDocFreq(1)
                        .maxDocFreq(100)
                        .analyzer('testAnalyzer');
                    console.log(JSON.stringify(expected.toJSON()));
                    console.log(JSON.stringify(component.ejsQuery.toJSON()));
                    expect(component.ejsQuery.toJSON()).to.deep.equal(expected.toJSON());
                });
            });
        </script>
    </body>
</html>
